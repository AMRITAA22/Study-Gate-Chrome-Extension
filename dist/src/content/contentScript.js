const w=["twitter.com","facebook.com","instagram.com","reddit.com","youtube.com","tiktok.com"],S=window.location.hostname,T=w.some(e=>S.includes(e));T&&(E(),setInterval(E,5e3));function E(){chrome.storage.local.get(["accessExpiry"],e=>{const a=Date.now();e.accessExpiry&&a<e.accessExpiry||document.getElementById("focus-gate-overlay")||C()})}function C(){window.stop(),document.documentElement.innerHTML="",fetch(chrome.runtime.getURL("src/content/overlay.html")).then(e=>e.text()).then(e=>{document.documentElement.innerHTML=e,I(),L()})}function I(){const e=document.createElement("link");e.href=chrome.runtime.getURL("src/content/overlay.css"),e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)}function L(){const e=document.getElementById("fg-subject-select"),a=document.getElementById("fg-start-btn"),y=document.getElementById("fg-quiz-section"),p=document.getElementById("fg-subject-section"),g=document.getElementById("fg-question-text"),m=document.getElementById("fg-options"),h=document.getElementById("fg-streak");chrome.storage.local.get(["nextQuizTime","studyData","streak","openaiKey","quizLength"],o=>{const r=Date.now(),t=o.nextQuizTime||0;if(h&&(h.textContent=`Streak: ${o.streak||0} üî•`),r<t){x(t);return}const n=Object.keys(o.studyData||{});if(n.length===0){e.innerHTML="<option disabled selected>No notes found. Go to Options!</option>",a.disabled=!0;return}e.innerHTML='<option value="" disabled selected>Select a Subject</option>',n.forEach(s=>{const l=document.createElement("option");l.value=s,l.text=s,e.add(l)}),v(o)});function x(o){p.style.display="none",y.style.display="none",document.querySelector(".fg-header h2").textContent="‚è≥ Strict Mode Active",document.querySelector(".fg-subtitle").textContent="You have used your 30 minutes.";const r=document.querySelector(".fg-glass-card"),t=document.createElement("div");t.style.marginTop="30px",t.innerHTML=`
      <div style="font-size: 16px; color: #94a3b8; margin-bottom: 10px;">
        Go study! The gate will re-open in:
      </div>
      <div id="fg-countdown" style="font-size: 48px; font-weight: 800; color: #facc15; font-family: monospace;">
        --:--
      </div>
      <div style="font-size: 12px; color: #64748b; margin-top: 20px;">
        (Blocking is enforced for 1 hour)
      </div>
    `,r.appendChild(t);const n=setInterval(()=>{const s=o-Date.now();if(s<=0)clearInterval(n),location.reload();else{const l=Math.floor(s/6e4),d=Math.floor(s%6e4/1e3);document.getElementById("fg-countdown").textContent=`${l}m ${d.toString().padStart(2,"0")}s`}},1e3)}function v(o){let r=[],t=0,n=0;a.addEventListener("click",()=>{const c=e.value;if(!c)return alert("Please select a subject!");a.textContent="Summoning AI...",a.disabled=!0;const u=o.studyData[c],i=o.openaiKey,k=o.quizLength||3;if(!i)return alert("API Key missing!");chrome.runtime.sendMessage({action:"GENERATE_QUIZ",notes:u,apiKey:i,qCount:k},f=>{a.disabled=!1,a.textContent="‚öîÔ∏è Challenge Gate",f&&f.success?(r=f.data,t=0,n=0,p.style.display="none",y.style.display="block",s()):alert("Error: "+(f?.error||"Unknown"))})});function s(){if(t>=r.length){d();return}const c=r[t];g.textContent=`${t+1}. ${c.question}`,m.innerHTML="",c.options.forEach(u=>{const i=document.createElement("button");i.textContent=u,i.onclick=()=>l(u,c.answer),m.appendChild(i)})}function l(c,u){c===u&&n++,t++,s()}function d(){const c=r.length,u=n/c*100;if(m.innerHTML="",u>=80)g.innerHTML=`
          <div style="color: #4ade80; font-size: 24px; font-weight: 800;">üéâ ACCESS GRANTED</div>
          <p>Score: ${n}/${c}</p>
          <p>You have 30 minutes before the 1-hour lockout begins.</p>
        `,setTimeout(()=>b(),2500);else{g.innerHTML=`
          <div style="color: #f87171; font-size: 24px; font-weight: 800;">‚õî FAILED</div>
          <p>Score: ${n}/${c}</p>
        `;const i=document.createElement("button");i.textContent="üîÑ Retry Quiz",i.className="fg-btn-danger",i.onclick=()=>location.reload(),m.appendChild(i)}}}function b(){const o=Date.now(),r=1800*1e3,t=3600*1e3,n=o+r,s=n+t;chrome.storage.local.get(["streak"],l=>{const d=(l.streak||0)+1;chrome.storage.local.set({accessExpiry:n,nextQuizTime:s,streak:d},()=>{location.reload()})})}}
